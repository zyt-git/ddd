<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>结算页</title>

	<link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
	<link rel="stylesheet" href="/js/bootstrop/css/bootstrap.min.css">
</head>

<body>
<!--head-->
<div id="nav"></div>

<div class="cart py-container" id="cartInfo">
	<!--logoArea-->
	<div class="logoArea">
		<div class="fl logo"><span class="title">结算页</span></div>
		<div class="fr search">
			<form class="sui-form form-inline">
				<div class="input-append">
					<input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营" />
					<button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
				</div>
			</form>
		</div>
	</div>
	<!--主内容-->
	<div class="checkout py-container">
		<div class="checkout-tit">
			<h4 class="tit-txt">填写并核对订单信息</h4>
		</div>
		<div class="checkout-steps">
			<!--收件人信息-->
			<div class="step-tit">
				<h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false" class="newadd" onclick="addAddress()">新增收货地址</a></span></h5>
			</div>
			<div class="step-cont">
				<div class="addressInfo">
					<ul class="addr-detail">
						<li class="addr-item" id="addressBody">





						</li>


					</ul>
					<!--添加地址-->
					<div  tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
									<h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
								</div>
								<div class="modal-body">



								</div>
								<div class="modal-footer">
									<button type="button" data-ok="modal" class="sui-btn btn-primary btn-large">确定</button>
									<button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">取消</button>
								</div>
							</div>
						</div>
					</div>
					<!--确认地址-->
				</div>
				<div class="hr"></div>

			</div>
			<div class="hr"></div>
			<!--支付和送货-->
			<div class="payshipInfo">
				<div class="step-tit">
					<h5>支付方式</h5>
				</div>
				<div class="step-cont">
					<ul class="payType">
						<li class="selected">微信付款<span title="点击取消选择"></span></li>
						<li>货到付款<span title="点击取消选择"></span></li>
					</ul>
				</div>
				<div class="hr"></div>
				<div class="step-tit">
					<h5>送货清单</h5>
				</div>
				<div class="step-cont" >
					<ul class="send-detail" id="cartItemInfo" >


					</ul>
				</div>
				<div class="hr"></div>
			</div>
			<div class="linkInfo">
				<div class="step-tit">
					<h5>发票信息</h5>
				</div>
				<div class="step-cont">
					<input type="radio" value="1" name="bill">需要
					<input type="radio" value="0" name="bill">不需要
					<!--<span>普通发票（电子）</span>
					<span>个人</span>
					<span>明细</span>-->
				</div>
			</div>
			<div class="cardInfo">
				<div class="step-tit">
					<h5>使用优惠/抵用</h5>
				</div>
			</div>
		</div>
	</div>
	<div class="order-summary">
		<div class="static fr">
			<div class="list" >
				<span><i class="number">##totalCount##</i>件商品，总商品金额</span>
				<em class="allprice">¥##totalPrice##</em>
			</div>
			<div class="list">
				<span>返现：</span>
				<em class="money">0.00</em>
			</div>
			<div class="list">
				<span>运费：</span>
				<em class="transport">0.00</em>
			</div>
		</div>
	</div>
	<div class="clearfix trade" >
		<div class="fc-price">应付金额:　<span class="price">¥##totalPrice##</span></div>
		<div class="fc-receiverInfo">寄送至:北京市海淀区三环内 中关村软件园9号楼 收货人：某某某 159****3201</div>
	</div>
	<div class="submit">
		<a class="sui-btn btn-danger btn-xlarge" onclick="payOrder()">提交订单</a>
	</div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
	<div class="py-container">
		<div class="footlink">
			<div class="Mod-service">
				<ul class="Mod-Service-list">
					<li class="grid-service-item intro  intro1">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro2">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro  intro3">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro4">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro intro5">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
				</ul>
			</div>
			<div class="clearfix Mod-list">
				<div class="yui3-g">
					<div class="yui3-u-1-6">
						<h4>购物指南</h4>
						<ul class="unstyled">
							<li>购物流程</li>
							<li>会员介绍</li>
							<li>生活旅行/团购</li>
							<li>常见问题</li>
							<li>购物指南</li>
						</ul>

					</div>
					<div class="yui3-u-1-6">
						<h4>配送方式</h4>
						<ul class="unstyled">
							<li>上门自提</li>
							<li>211限时达</li>
							<li>配送服务查询</li>
							<li>配送费收取标准</li>
							<li>海外配送</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>支付方式</h4>
						<ul class="unstyled">
							<li>货到付款</li>
							<li>在线支付</li>
							<li>分期付款</li>
							<li>邮局汇款</li>
							<li>公司转账</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>售后服务</h4>
						<ul class="unstyled">
							<li>售后政策</li>
							<li>价格保护</li>
							<li>退款说明</li>
							<li>返修/退换货</li>
							<li>取消订单</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>特色服务</h4>
						<ul class="unstyled">
							<li>夺宝岛</li>
							<li>DIY装机</li>
							<li>延保服务</li>
							<li>品优购E卡</li>
							<li>品优购通信</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>帮助中心</h4>
						<img src="img/wx_cz.jpg">
					</div>
				</div>
			</div>
			<div class="Mod-copyright">
				<ul class="helpLink">
					<li>关于我们<span class="space"></span></li>
					<li>联系我们<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>商家入驻<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!--页面底部END-->
<li id="cartItemNone" style="display: none">

	<div class="sendGoods">

		<ul class="yui3-g">
			<li class="yui3-u-1-6">
				<span><img src="##imgPath##"/></span>
			</li>
			<li class="yui3-u-7-12">
				<div class="desc">##shopName##</div>
				<div class="seven">7天无理由退货</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="price">##subTotalCount##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="num">X##count##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="exit">有货</div>
			</li>
		</ul>
	</div>
</li>
<div id="addressNone" style="display: none">
	<div class="con name selected"><a href="javascript:;" >##addressName##<span title="点击取消选择">&nbsp;</span></a></div>
	<div class="con address">##allAddressInfo## <span>159****3201</span>
		<span class="base">默认地址</span>
		<span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false"  onclick="updateAddress('##id##')">编辑</a>&nbsp;&nbsp;<a onclick="delAddress('##id##')">删除</a></span>
	</div>
	<div class="clearfix"></div>
</div>

<div id="addAddressNone" style="display: none">
	<form  class="sui-form form-horizontal" >
		<div class="control-group">
			<label class="control-label">收货人：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="add_addressName">
			</div>
		</div>
		<div class="form-group">
			<label  class="col-sm-2 control-label" >地区</label>
			<div id="add_area">
			</div>
		</div>

		<div class="control-group">
			<label class="control-label">详细地址：</label>
			<div class="controls">
				<input type="text" class="input-large" id="add_address">
			</div>
		</div>
		<div class="control-group">
			<label class="control-label">联系电话：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="add_addressPhone">
			</div>
		</div>
		<div class="control-group">
			<label class="control-label">邮箱：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="add_addressEmail">
			</div>
		</div>


	</form>
</div>
<div id="updateAddressNone" style="display: none">
	<form  class="sui-form form-horizontal" >
		<div class="control-group">
			<label class="control-label">收货人：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="update_addressName">
			</div>
		</div>
		<div class="form-group" id="update_area">
			<label  class="col-sm-2 control-label" >地区</label>
		</div>

		<div class="control-group">
			<label class="control-label">详细地址：</label>
			<div class="controls">
				<input type="text" class="input-large" id="update_address">
			</div>
		</div>
		<div class="control-group">
			<label class="control-label">联系电话：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="update_addressPhone">
			</div>
		</div>
		<div class="control-group">
			<label class="control-label">邮箱：</label>
			<div class="controls">
				<input type="text" class="input-medium" id="update_addressEmail">
			</div>
		</div>


	</form>
</div>

<li id="shortageNone" style="display: none">

	<div class="sendGoods">

		<ul class="yui3-g">
			<li class="yui3-u-1-6">
				<span><img src="##imgPath##"/></span>
			</li>
			<li class="yui3-u-7-12">
				<div class="desc">##shopName##</div>
				<div class="seven">7天无理由退货</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="price">##subTotalCount##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="num">X##count##</div>
			</li>
			<li class="yui3-u-1-12">
				<div class="exit">缺货</div>
			</li>
		</ul>
	</div>
</li>



<script src="/js/jquery-3.3.1.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script src="/js/bootstrop/js/bootstrap.min.js"></script>
<script src="js/jquery.cookie.min.js"></script>
<script src="common/nav.js"></script>
<script src="/js/bootbox/bootbox.min.js"></script>
<script src="/js/bootbox/bootbox.locales.min.js"></script>
<script>
	$(function () {
		initOrderInfo();
        backup();
		initAddress();
        token();

    })


	function token() {
        $.ajax({
            url:"http://localhost:8081/idempotent",
            type:"get",
            success:function (result) {
                if(result.code==200){
                    token=result.data;
                    $.cookie("token",token);

                }
            }
        })
    }

	function initOrderInfo() {
        if(!loginFlag){
            $("#cartItemInfo").html("<h1 align='center'><a href='login.html'>请先登录或加入购物车</a></h1>");
        }
        if(loginFlag){
            //initAddArea();
            initOrder();
        }
    }
    //初始化订单
    function initOrder() {
        $.ajax({
            type:"get",
            url:"http://localhost:8081/carts",
            success:function (result) {
                //登录没有购物车
                if(result.code==4001){
                    $("#cartItemInfo").html("<h1 align='center'><a href='/'>请添加商品到购物车</a></h1>");
                }else if(result.code==200){
                    //console.log(result.data);
                    var v_data=result.data;
                    var v_cartItem=v_data.list;
                    var cartItemDiv=$("#cartItemNone").html();
                    for(var i=0;i<v_cartItem.length;i++){
                        var cartItem=v_cartItem[i];
                        var v_result=cartItemDiv.replace(/##shopName##/g,cartItem.shopName)
                            .replace(/##count##/g,cartItem.count)
                            .replace(/##subTotalCount##/g,cartItem.subTotalCount)
                            .replace(/##id##/g,cartItem.id)
                            .replace(/##imgPath##/g,cartItem.imgPath);

                        $("#cartItemInfo").append(v_result);
                    }
                    var carDiv=$("#cartInfo").html();
                    var v_down=carDiv.replace(/##totalCount##/g,v_data.totalCount)
                        .replace(/##totalPrice##/g,v_data.totalPrice);
                    $("#cartInfo").html(v_down);

                    $(".addr-item .name").click(function(){
                        $(this).toggleClass("selected").siblings().removeClass("selected");
                    });
                    $(".payType li").click(function(){
                        $(this).toggleClass("selected").siblings().removeClass("selected");
                    });

                }
            }
        })
    }
    
    function payOrder() {
	    if(!loginFlag){
            bootbox.alert({
                buttons: {
                    ok: {
                        label: '确定',
                        className: 'btn btn-default'
                    }
                },
                message: "请登录",
                size: 'large',
                title: "提示信息"
            });
		}else{
            var bill=$("input[name='bill']").val();
            $.ajax({
                url:"http://localhost:8081/orders",
                type:"post",
                beforeSend:function(request){
                    var value=$.cookie("x-auth");
                    request.setRequestHeader("x-auth",value);
                    var value=$.cookie("token");
                    request.setRequestHeader("token",value);
                },
                data:{"buyType":1},
                success:function (result) {
                    var shortageList=result.data;
                    if(result.code==200){
                        //把库存不足的展示出来
                        //alert(shortageList);
                        var result="";
                        if(shortageList.length==0){
                            //库存充足 可以条页面
                            location.href="pay.html";
                        }else{
                            //弹出对话框  把库存不足的商品信息展示出来
                            var shortageDiv=$("#shortageNone").html();
                            for(var i=0;i<shortageList.length;i++){
                                var shortage=shortageList[i];
                                result+=shortageDiv.replace(/##shopName##/g,shortage.shopName)
                                    .replace(/##count##/g,shortage.count)
                                    .replace(/##subTotalCount##/g,shortage.subTotalCount)
                                    .replace(/##imgPath##/g,shortage.imgPath);
                            }

                            bootbox.alert({
                                buttons: {
                                    ok: {
                                        label: '确定',
                                        className: 'btn btn-default'
                                    }
                                },
                                message: result+" ",
                                size: 'large',
                                title: "提示信息"
                            });
                        }
                    }
                    if(result.code==6001){
                        bootbox.alert({
                            buttons: {
                                ok: {
                                    label: '确定',
                                    className: 'btn btn-default'
                                }
                            },
                            message: result.msg+" ",
                            size: 'large',
                            title: "提示信息"
                        });
                    }
                }
            })
		}

    }

    //初始化地址
    function initAddress() {
		$.ajax({
			url:"http://localhost:8081/address",
			type:"get",
			success:function (result) {
				if(result.code==200){
				    var v_address=result.data;
				    //console.log(v_address);
				    var addressNone=$("#addressNone").html();
				    for(var i=0;i<v_address.length;i++){
                        var v_result=addressNone.replace(/##addressName##/g,v_address[i].addressName)
                            .replace(/##id##/g,v_address[i].id)
							.replace(/##allAddressInfo##/g,v_address[i].allAddressInfo);
                        $("#addressBody",addAddressDialog).append(v_result);

                        $(".address").hover(function(){
                            $(this).addClass("address-hover");
                        },function(){
                            $(this).removeClass("address-hover");
                        });


					}
				}
            }
		})
    }

    var addAddressSource;
    var updateAddressSource;
    function backup() {
        addAddressSource=$("#addAddressNone").html();
        updateAddressSource=$("#updateAddressNone").html();
    }

    //地区下拉
    function initAreaSelect(paramDiv,id,obj) {
        if(obj){
            $(obj).parent().nextAll().remove();
        }
        $.ajax({
            url:"http://localhost:8081/areas?id="+id,
			type:"get",
            success:function (result) {
                if (result.code == 200) {
                    //console.log(result.data);
                    if (result.data.length!=0) {
                        // 在指定的div中追加select
                        var v_str = '<div class="col-sm-2"><select class="form-control" name="areaSelect" onchange="initAreaSelect(\''+paramDiv+'\', this.value,this)"><option value="-1">==请选择==</option>';
                        var v_areaArr = result.data;
                        for (var i = 0; i < v_areaArr.length; i++) {
                            v_str += "<option value='"+v_areaArr[i].id+"' >"+v_areaArr[i].areaname+"</option>";
                        }
                        v_str += "</select></div>";
                        if (paramDiv == "search_area") {
                            $("#"+paramDiv).append(v_str);
                        }else if(paramDiv=="add_area"){
                            $("#"+paramDiv,addAddressDialog).append(v_str);
                        }else if(paramDiv=="update_area"){
                            $("#"+paramDiv,updateAddressDialog).append(v_str);
                        }
                    }
                }
            }
        })
    }

	//地址增加
    var addAddressDialog;
    function addAddress() {
        //地区三级联动
        initAreaSelect("add_area",0);
        addAddressDialog=bootbox.dialog({
            "title":"地址增加",
            "message":$("#addAddressNone form"),
            "size":"larger",
            buttons:{
                confirm:{
                    label:'确定',
                    className:'btn-success',
                    callback:function(){
                        var  v_addressName=$("#add_addressName",addAddressDialog).val();
                        var v_area1=$($("select[name='areaSelect']",addAddressDialog)[0]).val();
                        var v_area2=$($("select[name='areaSelect']",addAddressDialog)[1]).val();
                        var v_area3=$($("select[name='areaSelect']",addAddressDialog)[2]).val();
                        var v_address=$("#add_address",addAddressDialog).val();
                        var v_phone=$("#add_addressPhone",addAddressDialog).val();
                        var v_email=$("#add_addressEmail",addAddressDialog).val();

                        v_param={};
                        v_param.addressName=v_addressName;
                        v_param.area1=v_area1;
                        v_param.area2=v_area2;
                        v_param.area3=v_area3;
                        v_param.address=v_address;
                        v_param.phone=v_phone;
                        v_param.email=v_email;



                        $.post({
                            url:"http://localhost:8081/address",
                            data:v_param,
                            success:function(result){
                                if(result.code==200){

                                }
                            },
                        })
                    },
                },
                cancel:{
                    label:'取消',
                    className:'btn-danger',
                }
            },
        })
        //还原
        $("#addAddressNone").html(addAddressSource);
    }

    //地区删除
	function delAddress(id) {
		$.ajax({
			url:"http://localhost:8081/address?id="+id,
			type:"delete",
			success:function (result) {
				if(result.code==200){
					location.reload();
				}
            }
		})
    }

    //地区修改
    var updateAddressDialog;
    var areanames;
	function updateAddress(id) {
        $.ajax({
            url:"http://localhost:8081/address/queryAddressId?id="+id,
			type:"get",
            success:function(result){
                if(result.code==200){
                    console.log(result);
                    var data=result.data;

                    $("#update_addressName").val(data.addressName);
                    $("#update_address").val(data.address);
                    $("#update_addressPhone").val(data.phone);
                    $("#update_addressEmail").val(data.email);


                    areanames=data.allAreas;
                    console.log(areanames);
                    $("#update_area").append('<div>'+data.allAreas+'<button class="btn btn-primary" type="button" onclick="edit(this)">\n' +
                        '            <span class="glyphicon glyphicon-pencil" ></span>编辑\n' +
                        '        </button><div>');

                    updateAddressDialog= bootbox.dialog({
                        title:'地区修改',
                        message:$("#updateAddressNone form"),
                        size:'large',
                        buttons:{
                            confirm:{
                                label:'确定',
                                className:'btn-success',
                                callback:function(){

                                    v_addressName=$("#update_addressName",updateAddressDialog).val();
                                    v_address=$("#update_address",updateAddressDialog).val();
                                    v_phone=$("#update_addressPhone",updateAddressDialog).val();
                                    v_email=$("#update_addressEmail",updateAddressDialog).val();
                                    var v_area1=$($("select[name='areaSelect']",updateUserDialog)[0]).val();
                                    var v_area2=$($("select[name='areaSelect']",updateUserDialog)[1]).val();
                                    var v_area3=$($("select[name='areaSelect']",updateUserDialog)[2]).val();




                                    var v_param={};
                                    v_param.addressName=v_addressName;
                                    v_param.address=v_address;
                                    v_param.email=v_email;
                                    v_param.area1= v_area1;
                                    v_param.area2= v_area2;
                                    v_param.area3= v_area3;

                                    var str=JSON.stringify(v_param);
                                    $.post({
                                        url:"http://localhost:8081/address",
                                        contentType:"application/json;charset=UTF-8",
                                        type:"put",
                                        data:str,
                                        success:function(result){
                                            if(result.code==200){
                                                bootbox.alert("修改成功",function(){
                                                        location.reload();
                                                    }
                                                );
                                            }
                                        },
                                    })
                                },
                            },
                            cancel:{
                                label:'取消',
                                className:'btn-danger',
                            }
                        },
                    })
                    $("#updateAddressNone").html(updateAddressSource);
                }
            },
        })
    }


    function edit(obj) {
        $(obj).parent().remove();
        initAreaSelect("update_area",0);
        $("#update_area",updateAddressDialog).append('<button class="btn btn-primary" type="button" onclick="cancelEdit()">' +
            '<span class="glyphicon glyphicon-pencil" ></span>取消编辑' +
            '</button>');
    }

    //取消编辑
    function cancelEdit() {
        $("#update_area",updateAddressDialog).html('<label  class="col-sm-2 control-label" >地区</label><div>'+areanames+'<button class="btn btn-primary" type="button" onclick="edit(this)">\n' +
            '<span class="glyphicon glyphicon-pencil" ></span>编辑' +
            '</button></div>');
    }








</script>



</body>

</html>